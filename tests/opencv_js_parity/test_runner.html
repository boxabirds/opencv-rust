<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OpenCV.js API Parity - Bit-Level Verification Tests</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #1e1e1e;
      color: #e0e0e0;
      padding: 20px;
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 30px;
      border-radius: 10px;
      margin-bottom: 30px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    .subtitle {
      font-size: 1.1em;
      opacity: 0.9;
    }

    .controls {
      background: #2d2d2d;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .status {
      background: #2d2d2d;
      padding: 15px 20px;
      border-radius: 6px;
      border-left: 4px solid #667eea;
    }

    .status.loading {
      border-left-color: #f59e0b;
    }

    .status.success {
      border-left-color: #10b981;
    }

    .status.error {
      border-left-color: #ef4444;
    }

    .results-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .test-result {
      background: #2d2d2d;
      border-radius: 10px;
      padding: 20px;
      border: 2px solid transparent;
      transition: border-color 0.3s;
    }

    .test-result.pass {
      border-color: #10b981;
    }

    .test-result.fail {
      border-color: #ef4444;
    }

    .test-result.perfect {
      border-color: #fbbf24;
      box-shadow: 0 0 20px rgba(251, 191, 36, 0.3);
    }

    .test-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #404040;
    }

    .test-name {
      font-size: 1.3em;
      font-weight: bold;
    }

    .test-badge {
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.9em;
      font-weight: bold;
    }

    .test-badge.pass {
      background: #10b981;
      color: white;
    }

    .test-badge.fail {
      background: #ef4444;
      color: white;
    }

    .test-badge.perfect {
      background: #fbbf24;
      color: #1e1e1e;
    }

    .metrics {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin: 15px 0;
    }

    .metric {
      background: #1e1e1e;
      padding: 10px;
      border-radius: 6px;
    }

    .metric-label {
      font-size: 0.85em;
      color: #9ca3af;
      margin-bottom: 5px;
    }

    .metric-value {
      font-size: 1.2em;
      font-weight: bold;
    }

    .metric-value.good {
      color: #10b981;
    }

    .metric-value.warning {
      color: #f59e0b;
    }

    .metric-value.bad {
      color: #ef4444;
    }

    .failures {
      background: #2d1f1f;
      border-left: 3px solid #ef4444;
      padding: 10px 15px;
      margin-top: 10px;
      border-radius: 4px;
    }

    .failures-title {
      font-weight: bold;
      color: #ef4444;
      margin-bottom: 8px;
    }

    .failure-item {
      font-size: 0.9em;
      padding: 4px 0;
      color: #fca5a5;
    }

    .summary {
      background: linear-gradient(135deg, #2d2d2d 0%, #1e1e1e 100%);
      padding: 30px;
      border-radius: 10px;
      margin-top: 30px;
      border: 2px solid #404040;
    }

    .summary-title {
      font-size: 2em;
      margin-bottom: 20px;
      text-align: center;
    }

    .summary-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .summary-stat {
      background: #1e1e1e;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }

    .summary-stat-value {
      font-size: 3em;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .summary-stat-label {
      font-size: 1.1em;
      color: #9ca3af;
    }

    pre {
      background: #1e1e1e;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
      line-height: 1.4;
    }

    .spinner {
      border: 3px solid #404040;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      display: inline-block;
      vertical-align: middle;
      margin-right: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .image-comparison {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 15px;
    }

    .comparison-image {
      text-align: center;
    }

    .comparison-image canvas {
      max-width: 100%;
      border: 2px solid #404040;
      border-radius: 4px;
    }

    .comparison-label {
      margin-top: 5px;
      font-size: 0.9em;
      color: #9ca3af;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üî¨ OpenCV.js API Parity Verification</h1>
      <p class="subtitle">Bit-level comparison testing between opencv.js and opencv-rust</p>
    </header>

    <div class="controls">
      <button id="runTestsBtn" onclick="runTests()">‚ñ∂Ô∏è Run All Tests</button>
      <button id="clearBtn" onclick="clearResults()">üóëÔ∏è Clear Results</button>
      <button onclick="exportResults()">üìä Export JSON</button>
      <div class="status" id="status">
        Ready to run tests
      </div>
    </div>

    <div id="progress" style="display: none;">
      <div class="status loading">
        <div class="spinner"></div>
        <span id="progressText">Initializing...</span>
      </div>
    </div>

    <div id="results" class="results-container"></div>

    <div id="summary" style="display: none;"></div>

    <div id="console-output" style="margin-top: 30px;">
      <h2>Console Output</h2>
      <pre id="console"></pre>
    </div>
  </div>

  <!-- Load OpenCV.js from CDN -->
  <script async src="https://docs.opencv.org/4.8.0/opencv.js" type="text/javascript"></script>

  <!-- Load our compatibility layer and test harness -->
  <script type="module">
    import cv from './opencv_compat.js';
    import { initTests, runAllTests, ComparisonResult } from './bit_level_tests.js';

    let testResults = null;
    let opencvJsReady = false;
    let opencvRustReady = false;

    // Wait for OpenCV.js to load
    function waitForOpenCVJs() {
      return new Promise((resolve) => {
        if (typeof window.cv !== 'undefined' && window.cv.Mat) {
          opencvJsReady = true;
          resolve(window.cv);
        } else {
          setTimeout(() => waitForOpenCVJs().then(resolve), 100);
        }
      });
    }

    // Initialize
    async function init() {
      updateStatus('Loading opencv.js...', 'loading');

      try {
        // Wait for opencv.js
        const cvJs = await waitForOpenCVJs();
        console.log('‚úÖ opencv.js loaded');

        // Initialize GPU for opencv-rust
        updateStatus('Initializing opencv-rust WebGPU...', 'loading');
        await cv.initGpu();
        opencvRustReady = true;
        console.log('‚úÖ opencv-rust loaded with GPU support');

        // Initialize test harness
        initTests(cvJs, cv, null);

        updateStatus('‚úÖ Ready to run tests', 'success');
        document.getElementById('runTestsBtn').disabled = false;

      } catch (error) {
        updateStatus(`‚ùå Error: ${error.message}`, 'error');
        console.error('Initialization error:', error);
      }
    }

    function updateStatus(message, type = '') {
      const statusEl = document.getElementById('status');
      statusEl.textContent = message;
      statusEl.className = `status ${type}`;
    }

    async function runTests() {
      if (!opencvJsReady || !opencvRustReady) {
        alert('Libraries not yet loaded. Please wait...');
        return;
      }

      // Disable button
      document.getElementById('runTestsBtn').disabled = true;

      // Show progress
      document.getElementById('progress').style.display = 'block';
      document.getElementById('progressText').textContent = 'Running tests...';

      // Clear previous results
      clearResults();

      // Capture console output
      const consoleOutput = [];
      const originalLog = console.log;
      console.log = function(...args) {
        consoleOutput.push(args.join(' '));
        originalLog.apply(console, args);
      };

      try {
        // Run all tests
        const { allResults, summary } = await runAllTests();
        testResults = { allResults, summary };

        // Restore console
        console.log = originalLog;

        // Display results
        displayResults(allResults);
        displaySummary(summary);

        // Update console output
        document.getElementById('console').textContent = consoleOutput.join('\n');

        // Hide progress
        document.getElementById('progress').style.display = 'none';

        // Update status
        const successRate = summary.successRate.toFixed(1);
        updateStatus(`‚úÖ Tests complete: ${summary.passed}/${summary.total} passed (${successRate}%)`, 'success');

      } catch (error) {
        console.log = originalLog;
        updateStatus(`‚ùå Error running tests: ${error.message}`, 'error');
        console.error('Test error:', error);
        document.getElementById('progress').style.display = 'none';
      }

      // Re-enable button
      document.getElementById('runTestsBtn').disabled = false;
    }

    function displayResults(results) {
      const container = document.getElementById('results');
      container.innerHTML = '';

      results.forEach(result => {
        const resultEl = createResultElement(result);
        container.appendChild(resultEl);
      });
    }

    function createResultElement(result) {
      const div = document.createElement('div');
      div.className = `test-result ${result.pass ? 'pass' : 'fail'} ${result.bitPerfect ? 'perfect' : ''}`;

      const badge = result.bitPerfect ? 'perfect' : (result.pass ? 'pass' : 'fail');
      const badgeText = result.bitPerfect ? 'üéØ BIT-PERFECT' : (result.pass ? '‚úÖ PASS' : '‚ùå FAIL');

      div.innerHTML = `
        <div class="test-header">
          <div class="test-name">${result.operationName}</div>
          <div class="test-badge ${badge}">${badgeText}</div>
        </div>

        <div class="metrics">
          <div class="metric">
            <div class="metric-label">opencv.js Time</div>
            <div class="metric-value">${result.opencvJsTime.toFixed(1)}ms</div>
          </div>
          <div class="metric">
            <div class="metric-label">opencv-rust Time</div>
            <div class="metric-value good">${result.opencvRustTime.toFixed(1)}ms</div>
          </div>
          <div class="metric">
            <div class="metric-label">Speedup</div>
            <div class="metric-value good">${result.speedup.toFixed(2)}x</div>
          </div>
          <div class="metric">
            <div class="metric-label">Image Size</div>
            <div class="metric-value">${result.imageSize.width}√ó${result.imageSize.height}</div>
          </div>
          <div class="metric">
            <div class="metric-label">Max Pixel Diff</div>
            <div class="metric-value ${result.maxDiff <= result.tolerance.maxDiff ? 'good' : 'bad'}">
              ${result.maxDiff} / ${result.tolerance.maxDiff}
            </div>
          </div>
          <div class="metric">
            <div class="metric-label">Mean Diff</div>
            <div class="metric-value ${result.meanDiff <= result.tolerance.meanDiffThreshold ? 'good' : 'bad'}">
              ${result.meanDiff.toFixed(3)}
            </div>
          </div>
          <div class="metric">
            <div class="metric-label">RMSE</div>
            <div class="metric-value">${result.rmse.toFixed(3)}</div>
          </div>
          <div class="metric">
            <div class="metric-label">Different Pixels</div>
            <div class="metric-value ${result.percentDifferent <= result.tolerance.percentDifferent ? 'good' : 'bad'}">
              ${result.differentPixels} (${result.percentDifferent.toFixed(3)}%)
            </div>
          </div>
        </div>

        ${result.failures.length > 0 ? `
          <div class="failures">
            <div class="failures-title">‚ö†Ô∏è Failures:</div>
            ${result.failures.map(f => `<div class="failure-item">‚Ä¢ ${f}</div>`).join('')}
          </div>
        ` : ''}
      `;

      return div;
    }

    function displaySummary(summary) {
      const container = document.getElementById('summary');
      container.style.display = 'block';

      container.innerHTML = `
        <div class="summary">
          <div class="summary-title">üìä Test Summary</div>
          <div class="summary-stats">
            <div class="summary-stat">
              <div class="summary-stat-value" style="color: #667eea;">${summary.total}</div>
              <div class="summary-stat-label">Total Tests</div>
            </div>
            <div class="summary-stat">
              <div class="summary-stat-value" style="color: #10b981;">${summary.passed}</div>
              <div class="summary-stat-label">Passed</div>
            </div>
            <div class="summary-stat">
              <div class="summary-stat-value" style="color: #ef4444;">${summary.failed}</div>
              <div class="summary-stat-label">Failed</div>
            </div>
            <div class="summary-stat">
              <div class="summary-stat-value" style="color: #fbbf24;">${summary.bitPerfect}</div>
              <div class="summary-stat-label">Bit-Perfect</div>
            </div>
            <div class="summary-stat">
              <div class="summary-stat-value" style="color: #8b5cf6;">${summary.avgSpeedup.toFixed(2)}x</div>
              <div class="summary-stat-label">Avg Speedup</div>
            </div>
            <div class="summary-stat">
              <div class="summary-stat-value" style="color: #10b981;">${summary.successRate.toFixed(1)}%</div>
              <div class="summary-stat-label">Success Rate</div>
            </div>
          </div>
        </div>
      `;
    }

    function clearResults() {
      document.getElementById('results').innerHTML = '';
      document.getElementById('summary').style.display = 'none';
      document.getElementById('console').textContent = '';
      testResults = null;
    }

    function exportResults() {
      if (!testResults) {
        alert('No test results to export. Run tests first.');
        return;
      }

      const json = JSON.stringify(testResults, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `opencv-parity-test-results-${new Date().toISOString()}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Make functions available globally
    window.runTests = runTests;
    window.clearResults = clearResults;
    window.exportResults = exportResults;

    // Initialize on load
    init();
  </script>
</body>
</html>
