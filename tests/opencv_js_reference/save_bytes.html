<!DOCTYPE html>
<html>
<head>
    <title>Save Comparison Bytes</title>
</head>
<body>
    <h1>Saving comparison bytes...</h1>
    <div id="status">Loading...</div>

    <script async src="/cache/opencv.js"></script>
    <script type="module">
        async function main() {
            // Wait for OpenCV.js
            while (!window.cv || !cv.Mat) {
                await new Promise(resolve => setTimeout(resolve, 100));
            }

            // Load our WASM
            const module = await import('/pkg/opencv_rust.js');
            await module.default();
            try { await module.initGpu(); } catch(e) { console.log('GPU init failed:', e); }

            document.getElementById('status').textContent = 'Processing...';

            // Load test image
            const img = await loadImage('/tests/fixtures/lenna.png');
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            const imageData = ctx.getImageData(0, 0, img.width, img.height);

            // OpenCV.js blur
            const cvSrc = cv.matFromImageData(imageData);
            const cvDst = new cv.Mat();
            cv.GaussianBlur(cvSrc, cvDst, new cv.Size(5, 5), 1.5, 1.5, cv.BORDER_DEFAULT);

            const cvCanvas = document.createElement('canvas');
            cvCanvas.width = img.width;
            cvCanvas.height = img.height;
            cv.imshow(cvCanvas, cvDst);
            const cvData = cvCanvas.getContext('2d').getImageData(0, 0, img.width, img.height);

            // Our WASM blur
            const wasmSrc = module.WasmMat.fromImageData(
                new Uint8Array(imageData.data),
                img.width, img.height, 4
            );
            const wasmDst = await module.gaussianBlur(wasmSrc, 5, 1.5);
            const wasmData = wasmDst.getData();

            // Create canvases for output images
            const opencvCanvas = document.createElement('canvas');
            opencvCanvas.width = img.width;
            opencvCanvas.height = img.height;
            const opencvCtx = opencvCanvas.getContext('2d');
            opencvCtx.putImageData(cvData, 0, 0);

            const wasmCanvas = document.createElement('canvas');
            wasmCanvas.width = img.width;
            wasmCanvas.height = img.height;
            const wasmCtx = wasmCanvas.getContext('2d');
            const wasmImageData = new ImageData(new Uint8ClampedArray(wasmData), img.width, img.height);
            wasmCtx.putImageData(wasmImageData, 0, 0);

            // Create difference image (amplified 10x)
            const diffCanvas = document.createElement('canvas');
            diffCanvas.width = img.width;
            diffCanvas.height = img.height;
            const diffCtx = diffCanvas.getContext('2d');
            const diffImageData = new ImageData(img.width, img.height);

            let diffCount = 0;
            let maxDiff = 0;
            for (let i = 0; i < cvData.data.length; i += 4) {
                let hasDiff = false;
                let channelMax = 0;
                for (let c = 0; c < 3; c++) {
                    const diff = Math.abs(cvData.data[i+c] - wasmData[i+c]);
                    if (diff > 0) {
                        hasDiff = true;
                        channelMax = Math.max(channelMax, diff);
                        maxDiff = Math.max(maxDiff, diff);
                    }
                }
                if (hasDiff) {
                    diffCount++;
                    // Amplify difference for visibility
                    const amplified = Math.min(255, channelMax * 10);
                    diffImageData.data[i] = amplified;
                    diffImageData.data[i+1] = amplified;
                    diffImageData.data[i+2] = amplified;
                }
                diffImageData.data[i+3] = 255; // Alpha
            }
            diffCtx.putImageData(diffImageData, 0, 0);

            // Save as PNG files
            downloadCanvas(opencvCanvas, 'opencv_output.png');
            downloadCanvas(wasmCanvas, 'wasm_output.png');
            downloadCanvas(diffCanvas, 'difference_10x.png');

            const totalPixels = img.width * img.height;
            const diffPercent = (diffCount / totalPixels * 100).toFixed(2);

            document.getElementById('status').innerHTML = `
                <p>âœ“ PNG images saved!</p>
                <p>opencv_output.png - OpenCV.js result (reference)</p>
                <p>wasm_output.png - Our WASM result (with truncation)</p>
                <p>difference_10x.png - Difference amplified 10x</p>
                <p></p>
                <p>Stats: ${diffCount} / ${totalPixels.toLocaleString()} pixels differ (${diffPercent}%)</p>
                <p>Max difference: ${maxDiff} (out of 255)</p>
                <p>Check your Downloads folder</p>
            `;

            // Cleanup
            cvSrc.delete();
            cvDst.delete();
            wasmSrc.free();
            wasmDst.free();
        }

        async function loadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = src;
            });
        }

        function downloadCanvas(canvas, filename) {
            canvas.toBlob(function(blob) {
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            });
        }

        main().catch(err => {
            document.getElementById('status').textContent = 'Error: ' + err.message;
            console.error(err);
        });
    </script>
</body>
</html>
