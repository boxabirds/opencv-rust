<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenCV.js Parity Test Harness</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        #status {
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #444;
            border-radius: 4px;
        }
        .loading { color: #f5923e; }
        .ready { color: #5cb85c; }
        .error { color: #d9534f; }
        canvas {
            border: 1px solid #444;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>OpenCV.js Parity Test Harness</h1>
    <div id="status" class="loading">Loading libraries...</div>
    <div id="details"></div>

    <!-- Canvas for image operations -->
    <canvas id="canvas" style="display: none;"></canvas>

    <!-- Load OpenCV.js from local cache (avoids CDN/network issues) -->
    <script async src="/cache/opencv.js"></script>

    <!-- Main test harness script -->
    <script type="module">
        // Global state
        window.testHarnessReady = false;
        window.opencv_js_ready = false;
        window.opencv_rust_ready = false;
        window.testImages = {};
        window.initSteps = []; // Track initialization steps

        const statusEl = document.getElementById('status');
        const detailsEl = document.getElementById('details');
        const startTime = performance.now();

        function getTimestamp() {
            return `[${(performance.now() - startTime).toFixed(2)}ms]`;
        }

        function updateStatus(message, className = 'loading') {
            statusEl.textContent = message;
            statusEl.className = className;
            const timestamped = `${getTimestamp()} [Test Harness] ${message}`;
            console.log(timestamped);
            window.initSteps.push({ time: performance.now() - startTime, message, className });
        }

        function addDetails(message) {
            const p = document.createElement('p');
            p.textContent = message;
            detailsEl.appendChild(p);
            console.log(`${getTimestamp()} [Details] ${message}`);
        }

        // Log memory usage if available
        function logMemoryUsage(label) {
            if (performance.memory) {
                const used = (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(2);
                const total = (performance.memory.totalJSHeapSize / 1024 / 1024).toFixed(2);
                console.log(`${getTimestamp()} [Memory] ${label}: ${used}MB used / ${total}MB total`);
            }
        }

        // Wait for OpenCV.js to load
        function waitForOpenCVJs() {
            console.log(`${getTimestamp()} [OpenCV.js] Starting wait for OpenCV.js...`);

            return new Promise((resolve, reject) => {
                const timeout = setTimeout(() => {
                    console.error(`${getTimestamp()} [OpenCV.js] TIMEOUT after 30s`);
                    reject(new Error('OpenCV.js load timeout'));
                }, 30000);

                // Check if already loaded
                if (typeof cv !== 'undefined' && cv.Mat) {
                    console.log(`${getTimestamp()} [OpenCV.js] Already loaded!`);
                    clearTimeout(timeout);
                    resolve();
                    return;
                }

                console.log(`${getTimestamp()} [OpenCV.js] Not yet loaded, setting up callback...`);

                // OpenCV.js sets this callback when ready
                window.onOpenCVReady = () => {
                    console.log(`${getTimestamp()} [OpenCV.js] onOpenCVReady callback fired!`);
                    logMemoryUsage('After OpenCV.js load');
                    clearTimeout(timeout);
                    resolve();
                };

                // Also monitor the script tag
                const scriptTag = document.querySelector('script[src="/cache/opencv.js"]');
                if (scriptTag) {
                    console.log(`${getTimestamp()} [OpenCV.js] Script tag found, readyState: ${scriptTag.readyState}`);

                    scriptTag.addEventListener('load', () => {
                        console.log(`${getTimestamp()} [OpenCV.js] Script tag 'load' event fired`);
                    });

                    scriptTag.addEventListener('error', (e) => {
                        console.error(`${getTimestamp()} [OpenCV.js] Script tag 'error' event:`, e);
                        clearTimeout(timeout);
                        reject(new Error('OpenCV.js script load error'));
                    });
                }
            });
        }

        // Load our WASM module
        async function loadOpenCVRust() {
            try {
                console.log(`${getTimestamp()} [WASM] === Starting WASM module load ===`);
                logMemoryUsage('Before WASM load');

                console.log(`${getTimestamp()} [WASM] Step 1: Attempting to import /pkg/opencv_rust.js...`);

                // Import our WASM module (absolute path from web root)
                const importStart = performance.now();
                const module = await import('/pkg/opencv_rust.js');
                const importDuration = performance.now() - importStart;

                console.log(`${getTimestamp()} [WASM] Step 1 COMPLETE: Module imported in ${importDuration.toFixed(2)}ms`);
                console.log(`${getTimestamp()} [WASM] Module exports:`, Object.keys(module));
                logMemoryUsage('After module import');

                console.log(`${getTimestamp()} [WASM] Step 2: Initializing WASM (calling module.default())...`);
                const initStart = performance.now();

                await module.default();

                const initDuration = performance.now() - initStart;
                console.log(`${getTimestamp()} [WASM] Step 2 COMPLETE: WASM initialized in ${initDuration.toFixed(2)}ms`);
                logMemoryUsage('After WASM init');

                // Try to initialize GPU (may fail in headless mode, that's OK)
                console.log(`${getTimestamp()} [WASM] Step 3: Checking for GPU support...`);
                try {
                    if (module.init_gpu) {
                        console.log(`${getTimestamp()} [WASM] Step 3a: init_gpu found, attempting GPU initialization...`);
                        const gpuStart = performance.now();

                        await module.init_gpu();

                        const gpuDuration = performance.now() - gpuStart;
                        console.log(`${getTimestamp()} [WASM] Step 3a COMPLETE: GPU initialized in ${gpuDuration.toFixed(2)}ms`);
                        addDetails('✓ GPU initialized');
                        logMemoryUsage('After GPU init');
                    } else {
                        console.log(`${getTimestamp()} [WASM] Step 3b: No init_gpu function found (CPU mode)`);
                        addDetails('ℹ CPU mode (no GPU function)');
                    }
                } catch (e) {
                    console.warn(`${getTimestamp()} [WASM] Step 3 FAILED: GPU init failed (will use CPU):`, e);
                    console.warn(`${getTimestamp()} [WASM] GPU error stack:`, e.stack);
                    addDetails('⚠ GPU init failed (will use CPU): ' + e.message);
                }

                // Store module globally
                console.log(`${getTimestamp()} [WASM] Step 4: Storing module globally...`);
                window.opencvRust = module;
                window.opencv_rust_ready = true;
                console.log(`${getTimestamp()} [WASM] Step 4 COMPLETE: Module stored as window.opencvRust`);
                logMemoryUsage('After storing module');

                console.log(`${getTimestamp()} [WASM] === WASM module load COMPLETE ===`);
                return module;

            } catch (error) {
                console.error(`${getTimestamp()} [WASM] === WASM LOAD FAILED ===`);
                console.error(`${getTimestamp()} [WASM] Error message:`, error.message);
                console.error(`${getTimestamp()} [WASM] Error stack:`, error.stack);
                console.error(`${getTimestamp()} [WASM] Full error:`, error);
                logMemoryUsage('After WASM error');

                throw new Error(`Failed to load opencv-rust: ${error.message}`);
            }
        }

        // Load test image
        window.loadTestImage = async function(imagePath) {
            const fullPath = `/tests/fixtures/${imagePath}`;

            // Check cache
            if (window.testImages[imagePath]) {
                return window.testImages[imagePath];
            }

            return new Promise((resolve, reject) => {
                const img = new Image();

                img.onload = () => {
                    // Draw to canvas to get ImageData
                    const canvas = document.getElementById('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;

                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);

                    const imageData = ctx.getImageData(0, 0, img.width, img.height);

                    // Cache it
                    window.testImages[imagePath] = imageData;

                    resolve(imageData);
                };

                img.onerror = () => {
                    reject(new Error(`Failed to load image: ${fullPath}`));
                };

                img.src = fullPath;
            });
        };

        // Convert OpenCV.js Mat to ImageData
        window.matToImageData = function(mat) {
            const canvas = document.getElementById('canvas');
            cv.imshow(canvas, mat);
            const ctx = canvas.getContext('2d');
            return ctx.getImageData(0, 0, mat.cols, mat.rows);
        };

        // Convert ImageData to OpenCV.js Mat
        window.imageDataToMat = function(imageData) {
            const canvas = document.getElementById('canvas');
            canvas.width = imageData.width;
            canvas.height = imageData.height;
            const ctx = canvas.getContext('2d');
            ctx.putImageData(imageData, 0, 0);
            return cv.imread(canvas);
        };

        // Main initialization
        async function initialize() {
            try {
                console.log(`${getTimestamp()} === INITIALIZATION START ===`);
                console.log(`${getTimestamp()} Browser: ${navigator.userAgent}`);
                console.log(`${getTimestamp()} WebGPU available: ${!!navigator.gpu}`);
                logMemoryUsage('Initialization start');

                updateStatus('Loading OpenCV.js...', 'loading');
                console.log(`${getTimestamp()} === PHASE 1: Loading OpenCV.js ===`);

                const opencvStart = performance.now();
                await waitForOpenCVJs();
                const opencvDuration = performance.now() - opencvStart;

                window.opencv_js_ready = true;
                console.log(`${getTimestamp()} === PHASE 1 COMPLETE: OpenCV.js loaded in ${opencvDuration.toFixed(2)}ms ===`);

                // Get OpenCV.js version info
                try {
                    const buildInfo = cv.getBuildInformation();
                    const version = buildInfo.split('\n')[0];
                    console.log(`${getTimestamp()} OpenCV.js version: ${version}`);
                    addDetails('✓ OpenCV.js loaded: ' + version);
                } catch (e) {
                    console.warn(`${getTimestamp()} Could not get OpenCV.js build info:`, e);
                    addDetails('✓ OpenCV.js loaded');
                }

                updateStatus('Loading opencv-rust WASM...', 'loading');
                console.log(`${getTimestamp()} === PHASE 2: Loading opencv-rust WASM ===`);

                const wasmStart = performance.now();
                await loadOpenCVRust();
                const wasmDuration = performance.now() - wasmStart;

                console.log(`${getTimestamp()} === PHASE 2 COMPLETE: WASM loaded in ${wasmDuration.toFixed(2)}ms ===`);
                addDetails('✓ opencv-rust WASM loaded');

                // All ready
                window.testHarnessReady = true;
                const totalDuration = performance.now() - startTime;
                updateStatus('✓ Test harness ready', 'ready');
                addDetails(`Ready for tests! Total init time: ${totalDuration.toFixed(2)}ms`);

                console.log(`${getTimestamp()} === INITIALIZATION COMPLETE ===`);
                console.log(`${getTimestamp()} Total time: ${totalDuration.toFixed(2)}ms`);
                console.log(`${getTimestamp()} OpenCV.js: ${opencvDuration.toFixed(2)}ms`);
                console.log(`${getTimestamp()} WASM: ${wasmDuration.toFixed(2)}ms`);
                logMemoryUsage('Initialization complete');

            } catch (error) {
                const failTime = performance.now() - startTime;
                console.error(`${getTimestamp()} === INITIALIZATION FAILED at ${failTime.toFixed(2)}ms ===`);
                console.error(`${getTimestamp()} Error type: ${error.constructor.name}`);
                console.error(`${getTimestamp()} Error message: ${error.message}`);
                console.error(`${getTimestamp()} Error stack:`, error.stack);

                updateStatus('✗ Initialization failed: ' + error.message, 'error');
                window.testHarnessError = error;

                // Log all init steps taken before failure
                console.error(`${getTimestamp()} Init steps before failure:`, window.initSteps);

                throw error;
            }
        }

        // Global error handlers
        window.addEventListener('error', (event) => {
            console.error(`${getTimestamp()} [GLOBAL ERROR]`, {
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno,
                error: event.error
            });
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error(`${getTimestamp()} [UNHANDLED REJECTION]`, {
                reason: event.reason,
                promise: event.promise
            });
        });

        // Start initialization
        console.log(`${getTimestamp()} Calling initialize()...`);
        initialize().catch(err => {
            console.error(`${getTimestamp()} [FATAL] Initialization failed:`, err);
        });

        // Export test utilities globally for Playwright tests
        window.testUtils = {
            ready: () => window.testHarnessReady,
            opencvJsReady: () => window.opencv_js_ready,
            opencvRustReady: () => window.opencv_rust_ready,
            loadTestImage: window.loadTestImage,
            matToImageData: window.matToImageData,
            imageDataToMat: window.imageDataToMat,
        };
    </script>
</body>
</html>
