<!DOCTYPE html>
<html>
<head>
    <title>Test Rounding Mode</title>
</head>
<body>
    <h1>Testing OpenCV Rounding Mode</h1>
    <pre id="output"></pre>

    <script async src="https://docs.opencv.org/4.5.0/opencv.js"></script>
    <script>
        async function test() {
            while (!window.cv || !cv.Mat) {
                await new Promise(resolve => setTimeout(resolve, 100));
            }

            const width = 5;
            const data = new Uint8ClampedArray(width * 4);
            for (let x = 0; x < width; x++) {
                const val = x * 64;
                data[x*4] = data[x*4+1] = data[x*4+2] = val;
                data[x*4+3] = 255;
            }

            const imageData = new ImageData(data, width, 1);
            const src = cv.matFromImageData(imageData);
            const dst = new cv.Mat();

            cv.GaussianBlur(src, dst, new cv.Size(5, 1), 1.5, 1.5, cv.BORDER_REFLECT);

            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = 1;
            cv.imshow(canvas, dst);
            const result = canvas.getContext('2d').getImageData(0, 0, width, 1);

            const kernel = [246, 479, 598, 479, 246];
            const gradient = [0, 64, 128, 192, 255];

            let output = 'Testing with truncation vs rounding:\n\n';

            for (let x = 0; x < width; x++) {
                let sum = 0;
                for (let i = 0; i < 5; i++) {
                    const offset = i - 2;
                    let sampleX = x + offset;

                    if (sampleX < 0) {
                        sampleX = -sampleX - 1;
                    } else if (sampleX >= width) {
                        sampleX = 2 * width - sampleX - 1;
                    }
                    sampleX = Math.max(0, Math.min(sampleX, width - 1));

                    sum += gradient[sampleX] * kernel[i];
                }

                const truncated = sum >> 11;
                const rounded = (sum + 1024) >> 11;
                const opencv = result.data[x*4];

                output += `x=${x}: sum=${sum}\n`;
                output += `  Truncated: ${truncated}`;
                if (truncated === opencv) output += ' ✓ MATCH';
                output += '\n';
                output += `  Rounded: ${rounded}`;
                if (rounded === opencv) output += ' ✓ MATCH';
                output += '\n';
                output += `  OpenCV: ${opencv}\n\n`;
            }

            document.getElementById('output').textContent = output;

            src.delete();
            dst.delete();
        }

        test();
    </script>
</body>
</html>
