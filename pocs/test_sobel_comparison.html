<!DOCTYPE html>
<html>
<head>
    <title>Sobel Detailed Comparison</title>
    <style>
        body { font-family: monospace; }
        .diff { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <h1>Sobel Detailed Comparison</h1>
    <div id="status">Loading...</div>
    <div id="results"></div>

    <script async src="https://docs.opencv.org/4.5.0/opencv.js"></script>
    <script type="module">
        async function loadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = src;
            });
        }

        async function runTest() {
            const status = document.getElementById('status');
            const results = document.getElementById('results');

            while (!window.cv || !cv.Mat) {
                await new Promise(resolve => setTimeout(resolve, 100));
            }

            status.textContent = 'Loading WASM...';
            const wasmModule = await import('/pkg/opencv_rust.js');
            await wasmModule.default();
            await wasmModule.initGpu();

            status.textContent = 'Loading image...';
            const testImage = await loadImage('lenna.png');

            const canvas = document.createElement('canvas');
            canvas.width = testImage.width;
            canvas.height = testImage.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(testImage, 0, 0);
            const imageData = ctx.getImageData(0, 0, testImage.width, testImage.height);

            // OpenCV.js processing
            status.textContent = 'Running OpenCV.js...';
            const cvSrc = cv.matFromImageData(imageData);
            const gray = new cv.Mat();
            cv.cvtColor(cvSrc, gray, cv.COLOR_RGBA2GRAY);
            const cvDst = new cv.Mat();
            cv.Sobel(gray, cvDst, cv.CV_8U, 1, 0, 3);

            // Get OpenCV grayscale intermediate
            const grayCanvas = document.createElement('canvas');
            grayCanvas.width = testImage.width;
            grayCanvas.height = testImage.height;
            cv.imshow(grayCanvas, gray);
            const grayImageData = grayCanvas.getContext('2d').getImageData(0, 0, testImage.width, testImage.height);

            // Get OpenCV result
            const cvCanvas = document.createElement('canvas');
            cvCanvas.width = testImage.width;
            cvCanvas.height = testImage.height;
            cv.imshow(cvCanvas, cvDst);
            const cvData = cvCanvas.getContext('2d').getImageData(0, 0, testImage.width, testImage.height);

            // WASM processing - manual grayscale conversion
            status.textContent = 'Running WASM...';
            const grayData = new Uint8Array(testImage.width * testImage.height);
            for (let i = 0; i < grayData.length; i++) {
                const r = imageData.data[i*4];
                const g = imageData.data[i*4+1];
                const b = imageData.data[i*4+2];
                grayData[i] = Math.round(0.299 * r + 0.587 * g + 0.114 * b);
            }

            const wasmSrc = wasmModule.WasmMat.fromImageData(grayData, testImage.width, testImage.height, 1);
            const wasmDst = await wasmModule.sobel(wasmSrc, 1, 0, 3);
            const wasmData = wasmDst.getData();

            // Find first 20 pixels with differences
            let html = '<h3>First 20 pixels with differences:</h3><table border="1"><tr><th>X</th><th>Y</th><th>Gray (OpenCV)</th><th>Gray (Manual)</th><th>Sobel (OpenCV)</th><th>Sobel (WASM)</th><th>Diff</th></tr>';

            let found = 0;
            let totalPixels = testImage.width * testImage.height;
            for (let i = 0; i < totalPixels && found < 20; i++) {
                const cvSobel = cvData.data[i * 4];
                const wasmSobel = wasmData[i];
                const diff = Math.abs(cvSobel - wasmSobel);

                if (diff > 0) {
                    const x = i % testImage.width;
                    const y = Math.floor(i / testImage.width);
                    const cvGray = grayImageData.data[i * 4];
                    const manualGray = grayData[i];

                    html += `<tr class="diff"><td>${x}</td><td>${y}</td><td>${cvGray}</td><td>${manualGray}</td><td>${cvSobel}</td><td>${wasmSobel}</td><td>${diff}</td></tr>`;
                    found++;
                }
            }
            html += '</table>';

            // Overall stats
            let diffCount = 0;
            let maxDiff = 0;
            let totalPixels = testImage.width * testImage.height;

            for (let i = 0; i < totalPixels; i++) {
                const cvVal = cvData.data[i * 4];
                const wasmVal = wasmData[i];
                const diff = Math.abs(cvVal - wasmVal);
                if (diff > 0) {
                    diffCount++;
                    maxDiff = Math.max(maxDiff, diff);
                }
            }

            const accuracy = ((totalPixels - diffCount) / totalPixels * 100).toFixed(2);
            html += `<h3>Overall Statistics:</h3>`;
            html += `<p>Accuracy: ${accuracy}%</p>`;
            html += `<p>Different pixels: ${diffCount.toLocaleString()} / ${totalPixels.toLocaleString()}</p>`;
            html += `<p>Max difference: ${maxDiff}</p>`;

            results.innerHTML = html;
            status.textContent = 'Complete!';

            cvSrc.delete();
            gray.delete();
            cvDst.delete();
            wasmSrc.free();
            wasmDst.free();
        }

        runTest().catch(err => {
            document.getElementById('status').textContent = 'Error: ' + err.message;
            console.error(err);
        });
    </script>
</body>
</html>
