<!DOCTYPE html>
<html>
<head>
    <title>Grayscale Debug</title>
</head>
<body>
    <h1>Grayscale Debug</h1>
    <div id="results"></div>

    <script async src="https://docs.opencv.org/4.5.0/opencv.js"></script>
    <script type="module">
        async function loadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = src;
            });
        }

        async function runTest() {
            const results = document.getElementById('results');

            while (!window.cv || !cv.Mat) {
                await new Promise(resolve => setTimeout(resolve, 100));
            }

            const wasmModule = await import('/pkg/opencv_rust.js');
            await wasmModule.default();
            await wasmModule.initGpu();

            const testImage = await loadImage('lenna.png');

            const canvas = document.createElement('canvas');
            canvas.width = testImage.width;
            canvas.height = testImage.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(testImage, 0, 0);
            const imageData = ctx.getImageData(0, 0, testImage.width, testImage.height);

            // OpenCV.js
            const cvSrc = cv.matFromImageData(imageData);
            const cvDst = new cv.Mat();
            cv.cvtColor(cvSrc, cvDst, cv.COLOR_RGBA2GRAY);

            const cvCanvas = document.createElement('canvas');
            cvCanvas.width = testImage.width;
            cvCanvas.height = testImage.height;
            cv.imshow(cvCanvas, cvDst);
            const cvData = cvCanvas.getContext('2d').getImageData(0, 0, testImage.width, testImage.height);

            // WASM
            const wasmSrc = wasmModule.WasmMat.fromImageData(
                new Uint8Array(imageData.data),
                testImage.width, testImage.height, 4
            );
            const wasmDst = await wasmModule.rgbToGray(wasmSrc);
            const wasmData = wasmDst.getData();

            // Compare first 20 pixels
            let html = '<h3>First 20 pixels:</h3><table border="1"><tr><th>Pixel</th><th>R</th><th>G</th><th>B</th><th>OpenCV Gray</th><th>WASM Gray</th><th>Diff</th></tr>';

            for (let i = 0; i < 20; i++) {
                const r = imageData.data[i * 4];
                const g = imageData.data[i * 4 + 1];
                const b = imageData.data[i * 4 + 2];
                const cvGray = cvData.data[i * 4]; // R channel
                const wasmGray = wasmData[i];
                const diff = Math.abs(cvGray - wasmGray);

                html += `<tr><td>${i}</td><td>${r}</td><td>${g}</td><td>${b}</td><td>${cvGray}</td><td>${wasmGray}</td><td>${diff}</td></tr>`;
            }
            html += '</table>';

            results.innerHTML = html;

            cvSrc.delete();
            cvDst.delete();
            wasmSrc.free();
            wasmDst.free();
        }

        runTest().catch(err => {
            document.getElementById('results').textContent = 'Error: ' + err.message;
            console.error(err);
        });
    </script>
</body>
</html>
